<script>
    let montantChoisi = 0;
    let waveOuvert = false;
    
    const NUMERO_WHATSAPP = "2250702980770";
    // CORRECTION ICI : J'ai enlevé le ";" et la guillemet en trop à la fin
    const SCRIPT_URL = "https://paiement-tiket-en-ligne.vercel.app/api/verifier";

    const LIENS_WAVE = {
        100: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=100",
        300: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=300",
        700: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=700",
        1300: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=1300",
        2000: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=2000"
    };

    function selectPlan(element, prix) {
        if (waveOuvert) return; 
        document.querySelectorAll('tr').forEach(row => row.classList.remove('selected-row'));
        element.classList.add('selected-row');
        montantChoisi = prix;
    }

    async function lancerProcessus() {
        const phone = document.getElementById('clientPhone').value.trim();
        const btn = document.getElementById('btnAction');
        const table = document.getElementById('forfaitTable');
        const lockMsg = document.getElementById('lock-msg');

        if (!phone || phone.length < 8) { alert("Numéro invalide !"); return; }
        if (montantChoisi === 0) { alert("Sélectionnez un forfait !"); return; }

        if (!waveOuvert) {
            waveOuvert = true;
            table.classList.add('locked');
            document.getElementById('clientPhone').disabled = true;
            lockMsg.style.display = 'block';

            window.open(LIENS_WAVE[montantChoisi], '_blank');
            
            btn.innerHTML = "J'AI PAYÉ, RECEVOIR MON CODE";
            btn.style.backgroundColor = "#25D366"; 
            return;
        }

        btn.innerHTML = "VÉRIFICATION...";
        btn.disabled = true;

        try {
            // Appel de ton API Vercel
            const response = await fetch(SCRIPT_URL + "?montant=" + montantChoisi + "&numero=" + phone);
            const codeRecu = await response.text();

            if (!codeRecu || codeRecu.trim() === "" || codeRecu === "STOCK_EPUISE") {
                alert("Paiement non trouvé ou plus de codes disponibles.");
                resetInterface();
                return;
            }

            const msg = "✅ PAIEMENT EFFECTUÉ\n" +
                        "Client : " + phone + "\n" +
                        "Forfait : " + montantChoisi + "f\n" +
                        "CODE WIFI : " + codeRecu + "\n\n" +
                        "⬇️⬇️⬇️⬇️⬇️⬇️⬇️⬇️\n\n" +
                        "*TRANSFERT LE MESSAGE POUR VALIDATION DU CODE*";
            
            window.location.href = "https://wa.me/" + NUMERO_WHATSAPP + "?text=" + encodeURIComponent(msg);
        } catch (error) {
            alert("Erreur de connexion au serveur.");
            btn.disabled = false;
            btn.innerHTML = "RÉESSAYER";
        }
    }

    function resetInterface() {
        waveOuvert = false;             
        const btn = document.getElementById('btnAction');
        const table = document.getElementById('forfaitTable');
        btn.disabled = false;
        btn.innerHTML = "Payer avec Wave";
        btn.style.backgroundColor = "";
        table.classList.remove('locked');
        document.getElementById('clientPhone').disabled = false;
        document.getElementById('lock-msg').style.display = 'none';
    }
</script>