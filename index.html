<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalmNet WiFi - Paiement S√©curis√©</title>
    <style>
        :root { --primary-blue: #4a7c82; --white: #ffffff; --wave-blue: #1c93e4; --wa-green: #25D366; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--primary-blue); color: var(--white); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .card { background-color: var(--primary-blue); width: 100%; max-width: 500px; border: 3px solid white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 4px solid white; }
        .logo-text { font-size: 32px; font-weight: bold; }
        .wifi-icon-bg { background-color: white; color: var(--primary-blue); padding: 5px 15px; border-radius: 50px; font-weight: bold; }
        .title-banner { background-color: rgba(0,0,0,0.2); padding: 10px; font-weight: bold; text-align: center; font-size: 14px; }
        
        .input-group { padding: 15px 20px; text-align: left; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; color: #333; outline: none; }
        input:disabled { background-color: #ddd; }

        table { width: 100%; border-collapse: collapse; }
        tr { cursor: pointer; transition: 0.2s; }
        td { padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.2); font-weight: bold; }
        
        /* Style quand une ligne est s√©lectionn√©e */
        .selected-row { background-color: white !important; color: #4a7c82 !important; }
        
        .locked { pointer-events: none; opacity: 0.6; }
        
        .footer-action { padding: 25px; text-align: center; }
        .btn-pay { background-color: var(--wave-blue); color: white; border: 2px solid white; padding: 18px; border-radius: 10px; font-size: 18px; font-weight: bold; width: 100%; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-pay:active { transform: scale(0.98); }
        #lock-msg { display: none; font-size: 13px; margin-top: 10px; color: #ffeb3b; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <div class="logo-text">PalmNet</div>
        <div class="wifi-icon-bg">Wi-Fi</div>
    </div>

    <div id="section-phone">
        <div class="title-banner">1. VOTRE NUM√âRO WAVE</div>
        <div class="input-group">
            <input type="tel" id="clientPhone" placeholder="Ex: 0707070707" maxlength="10">
        </div>
    </div>

    <div class="title-banner">2. CHOISISSEZ VOTRE FORFAIT</div>
    <table id="forfaitTable">
        <tbody>
            <tr onclick="selectPlan(this, 100)"><td>100 f</td><td>2 HEURES</td><td>2 H</td></tr>
            <tr onclick="selectPlan(this, 300)"><td>300 f</td><td>1 JOUR</td><td>1 J</td></tr>
            <tr onclick="selectPlan(this, 700)"><td>700 f</td><td>1 SEMAINE</td><td>7 J</td></tr>
            <tr onclick="selectPlan(this, 1300)"><td>1300 f</td><td>2 SEMAINES</td><td>14 J</td></tr>
            <tr onclick="selectPlan(this, 2000)"><td>2000 f</td><td>1 MOIS</td><td>30 J</td></tr>
        </tbody>
    </table>

    <div class="footer-action">
        <button id="btnAction" class="btn-pay" onclick="lancerProcessus()">Payer avec Wave</button>
        <div id="lock-msg">üîí FORFAIT VERROUILL√â POUR LE PAIEMENT</div>
    </div>
</div>

<script>
    let montantChoisi = 0;
    let waveOuvert = false;
    
    const NUMERO_WHATSAPP = "2250702980770";
    const SCRIPT_URL = "https://paiement-tiket-en-ligne.vercel.app/api/verifier";

    const LIENS_WAVE = {
        100: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=100",
        300: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=300",
        700: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=700",
        1300: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=1300",
        2000: "https://pay.wave.com/m/M_ci_PP4hSaF9_-Oe/c/ci/?amount=2000"
    };

    // CORRECTION SELECTION : On force le retrait de la classe sur toutes les lignes
    function selectPlan(element, prix) {
        if (waveOuvert) return; 
        const rows = document.querySelectorAll('#forfaitTable tr');
        rows.forEach(r => r.classList.remove('selected-row'));
        element.classList.add('selected-row');
        montantChoisi = prix;
    }

    async function lancerProcessus() {
        const phone = document.getElementById('clientPhone').value.trim();
        const btn = document.getElementById('btnAction');
        const table = document.getElementById('forfaitTable');
        const lockMsg = document.getElementById('lock-msg');

        if (!phone || phone.length < 8) { alert("Num√©ro invalide !"); return; }
        if (montantChoisi === 0) { alert("Veuillez s√©lectionner un forfait en cliquant dessus !"); return; }

        if (!waveOuvert) {
            waveOuvert = true;
            table.classList.add('locked');
            document.getElementById('clientPhone').disabled = true;
            lockMsg.style.display = 'block';

            // Redirection directe vers Wave au lieu d'un pop-up
            window.location.href = LIENS_WAVE[montantChoisi];
            
            // On laisse un petit d√©lai pour que l'utilisateur revienne apr√®s son paiement
            setTimeout(() => {
                btn.innerHTML = "J'AI PAY√â, RECEVOIR MON CODE";
                btn.style.backgroundColor = "#25D366"; 
            }, 1000);
            return;
        }

        btn.innerHTML = "V√âRIFICATION...";
        btn.disabled = true;

        try {
            const response = await fetch(`${SCRIPT_URL}?montant=${montantChoisi}&numero=${phone}`);
            const codeRecu = await response.text();

            if (!codeRecu || codeRecu.trim() === "" || codeRecu === "STOCK_EPUISE") {
                alert("Paiement non encore d√©tect√© ou stock √©puis√©. R√©essayez dans 10 secondes.");
                btn.disabled = false;
                btn.innerHTML = "J'AI PAY√â, RECEVOIR MON CODE";
                return;
            }

            const msg = "‚úÖ PAIEMENT EFFECTU√â\n" +
                        "Client : " + phone + "\n" +
                        "Forfait : " + montantChoisi + "f\n" +
                        "CODE WIFI : " + codeRecu + "\n\n" +
                        "‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è\n\n" +
                        "*GARDER CE MESSAGE POUR LE CODE*";
            
            // REDIRECTION AUTOMATIQUE VERS WHATSAPP
            window.location.href = "https://wa.me/" + NUMERO_WHATSAPP + "?text=" + encodeURIComponent(msg);
            
        } catch (error) {
            alert("Erreur r√©seau. V√©rifiez votre connexion.");
            btn.disabled = false;
            btn.innerHTML = "R√âESSAYER";
        }
    }
</script>
</body>
</html>